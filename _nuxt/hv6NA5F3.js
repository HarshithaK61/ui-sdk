import{d as _,j as l,l as h,O as C,x as b,o as y,y as v,e as S,I as x,a as p,n as k,F as M,K as W}from"./CIKIahH0.js";import{u as E,C as P}from"./f7xkK54W.js";import{A as D}from"./BTjLx_-T.js";import"./Byf87tck.js";import"./8NJXV5Ny.js";import"./r58-h6F_.js";import"./C3yoewId.js";const U={class:"container mx-auto p-4"},z=_({__name:"merchant-managed",setup(A){const a=l(!1),r=l(!1),s=l(null),t=l(),{requestChallengeFromBackend:w,verifyPresentationProof:g}=E(s),u=n=>{s.value||(s.value=new P({network:"testnet",walletConnectUri:n}))},f=async()=>{if(a.value=!a.value,!!a.value)try{t.value=new D,t.value.onSessionApproved=async e=>{console.log("Session approved callback triggered:",e),r.value=!0,await s.value?.showModal("processing"),await c(e)},await t.value.initClient();const n=t.value.getMostNewSession();if(n)console.log("Found existing session:  ",n),r.value=!0,u(),await s.value?.showModal("returning-user");else{const e=await t.value.connect("ccd:testnet");console.log("WalletConnect URI:",e),e&&(u(e),await s.value?.renderUIModals())}}catch(n){console.error("Error connecting wallet:",n),a.value=!1}},m=async n=>{if(!t.value)throw new Error("WalletConnect client not initialized");if(!t.value.getMostNewSession())throw new Error("No active session found");console.log("Sending presentation request via merchant WC client");const i=await t.value.request("request_verifiable_presentation_v1","ccd:4221332d34e1694168c2a0c0b3fd0f27",{...n.presentationRequest,metadata:{appName:"3P Account Wallet",description:"Merchant dApp using Concordium ID verification",url:window.location.origin,icons:[`${window.location.origin}/Concordium.png`]}});return console.log("Presentation response received:",i),i},c=async n=>{try{const e=await w();if(e&&t.value){const o=await m(e);await g(o)}}catch(e){console.error("Error in challenge/presentation flow:",e),s.value?.closeModal()}},d=async n=>{const{type:e,data:o}=n.detail;switch(console.log("SDK Event:",e,o),e){case"active_session":r.value=!0,console.log("Active session detected:",o),await c();break;case"session_disconnected":r.value=!1,a.value=!1,console.log("Session disconnected:",o);break;case"session_approved":r.value=!0,console.log("Session approved!",o),await new Promise(i=>setTimeout(i,500)),await c();break;case"error":console.error("SDK Error:",o),a.value=!1;break}};return h(()=>{window.addEventListener("verification-web-ui-event",d)}),C(()=>{window.removeEventListener("verification-web-ui-event",d)}),(n,e)=>{const o=x,i=W;return y(),b(i,null,{default:v(()=>[S(o,null,{default:v(()=>[p("div",U,[p("button",{onClick:e[0]||(e[0]=I=>f()),class:k(["px-6 py-2 rounded-lg font-medium transition-colors border",a.value?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-900 border-gray-300 hover:bg-gray-50"])},M(r.value?"Connected":a.value?"Connecting...":"Connect Merchant Wallet"),3)])]),_:1})]),_:1})}}});export{z as default};
